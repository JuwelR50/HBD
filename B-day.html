--- START OF FILE Bday.html ---

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Protocol: ASSIA-26</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Great+Vibes&family=Poppins:wght@300;500;800&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* -----------------------------------------------------------
           CORE & ANIMATED BACKGROUND
           ----------------------------------------------------------- */
        :root {
            --accent-gold: #ffd700;
            --neon-pink: #ff2a6d;
            --neon-blue: #05d9e8;
            --font-main: 'Poppins', sans-serif;
            --font-fun: 'Fredoka', sans-serif;
            --font-fancy: 'Great Vibes', cursive;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; user-select: none; -webkit-user-drag: none; cursor: none; }

        body {
            /* Northern Lights Gradient */
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab, #2e003e);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            color: #fff;
            font-family: var(--font-main);
            overflow: hidden;
            height: 100vh;
            width: 100vw;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* -----------------------------------------------------------
           CUSTOM CURSOR
           ----------------------------------------------------------- */
        .cursor-dot {
            width: 12px; height: 12px; background: #fff;
            position: fixed; border-radius: 50%; z-index: 9999; pointer-events: none;
            box-shadow: 0 0 10px #fff; mix-blend-mode: overlay;
        }
        .cursor-coin {
            width: 60px; height: 60px; 
            background: radial-gradient(circle at 30% 30%, #ffd700, #b8860b);
            border: 2px solid #fff;
            position: fixed; border-radius: 50%; z-index: 9999; pointer-events: none;
            display: flex; align-items: center; justify-content: center;
            font-size: 30px; color: #fff; font-weight: bold;
            box-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
            transform: translate(-50%, -50%) scale(0);
        }
        .cursor-coin::after { content: '$'; }

        /* -----------------------------------------------------------
           SCENE 1: THE VAULT
           ----------------------------------------------------------- */
        .vault-overlay {
            position: fixed; inset: 0; z-index: 100; display: flex;
            pointer-events: none;
        }
        .vault-door, .vault-lock-container { pointer-events: auto; }

        .vault-door {
            width: 50%; height: 100%; background: #111; position: relative;
            box-shadow: inset 0 0 50px #000; border-right: 2px solid #333;
            transition: transform 2s cubic-bezier(0.6, 0.05, 0.2, 0.99); z-index: 100;
            background-image: radial-gradient(#333 1px, transparent 1px); background-size: 20px 20px;
        }
        .vault-door.left { border-right: 5px solid #222; }
        .vault-door.right { border-left: 5px solid #222; }
        .vault-open .vault-door.left { transform: translateX(-100%); }
        .vault-open .vault-door.right { transform: translateX(100%); }

        .vault-lock-container {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 102; display: flex; flex-direction: column; align-items: center;
            transition: opacity 0.5s; width: 100%;
        }
        .vault-open .vault-lock-container { opacity: 0; pointer-events: none; }

        .scan-msg { 
            font-family: var(--font-main); font-weight: 800; margin-bottom: 20px; letter-spacing: 1px; 
            color: #fff; text-shadow: 0 0 20px rgba(0,0,0,0.8); text-align: center; width: 100%; min-height: 30px;
        }

        .charge-container {
            width: 150px; height: 150px; border-radius: 50%; border: 4px solid #444; background: #000;
            display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden;
            box-shadow: 0 0 40px rgba(0,0,0,0.8); cursor: pointer; -webkit-tap-highlight-color: transparent;
        }
        .charge-fill {
            position: absolute; inset: 0; background: var(--neon-blue);
            transform: scale(0); border-radius: 50%; opacity: 0.9; transition: background 0.3s;
        }
        .fingerprint-icon { font-size: 3.5rem; z-index: 2; color: #666; transition: 0.3s; pointer-events: none; }
        
        .shake-element { animation: shake 0.4s; }
        @keyframes shake { 0%, 100% {transform: translateX(0);} 25% {transform: translateX(-10px);} 75% {transform: translateX(10px);} }

        /* -----------------------------------------------------------
           ANIMATED WELCOME TEXT
           ----------------------------------------------------------- */
        .welcome-overlay {
            position: fixed; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 50; pointer-events: none; opacity: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(8px);
        }
        .welcome-overlay.visible { opacity: 1; }
        
        .welcome-text-container {
            font-family: var(--font-fancy); font-size: 5rem; color: #fff;
            text-align: center; line-height: 1.2; text-shadow: 0 5px 15px rgba(0,0,0,0.3);
            display: flex; flex-direction: column; gap: 10px;
        }
        .char { display: inline-block; opacity: 0; transform-origin: 50% 100%; }
        .char.highlight { color: var(--accent-gold); text-shadow: 0 0 30px var(--accent-gold); }

        /* -----------------------------------------------------------
           PRE-GAME MESSAGE
           ----------------------------------------------------------- */
        #pre-game-msg {
            position: fixed; inset: 0; z-index: 60; display: flex; align-items: center; justify-content: center;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); opacity: 0; pointer-events: none;
            flex-direction: column; text-align: center;
        }
        .pg-text { font-family: var(--font-fun); font-size: 3rem; color: var(--neon-blue); margin-bottom: 20px; transform: scale(0.8); }

        /* -----------------------------------------------------------
           SCENE 2: BALLOONS & GAME OVER
           ----------------------------------------------------------- */
        .scene {
            position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: 0.8s ease; z-index: 10;
        }
        .scene.active { opacity: 1; pointer-events: all; }

        .hud {
            position: fixed; top: 20px; width: 95%; max-width: 600px;
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(255,255,255,0.1); padding: 10px 25px; border-radius: 50px;
            border: 2px solid #fff; backdrop-filter: blur(10px);
            font-family: var(--font-fun); font-weight: bold; font-size: 1.2rem;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2); z-index: 20;
        }

        .balloon {
            position: absolute; width: 70px; height: 85px;
            border-radius: 50% 50% 50% 50% / 40% 40% 60% 60%;
            display: flex; align-items: center; justify-content: center;
            cursor: none; font-weight: bold; font-family: var(--font-fun); font-size: 1.5rem;
            box-shadow: inset -10px -10px 20px rgba(0,0,0,0.1), inset 10px 10px 20px rgba(255,255,255,0.4);
        }
        .balloon::after {
            content: ''; position: absolute; bottom: -60px; left: 50%;
            width: 2px; height: 50px; background: rgba(255,255,255,0.6); transform: translateX(-50%);
        }

        .bomb-container { position: absolute; width: 80px; height: 80px; display: flex; align-items: center; justify-content: center; cursor: none; }
        .bomb-body {
            width: 60px; height: 60px; background: radial-gradient(circle at 30% 30%, #444, #000);
            border-radius: 50%; position: relative; z-index: 2;
            box-shadow: 0 0 15px #ff0000; animation: pulseRed 0.5s infinite alternate;
            display: flex; align-items: center; justify-content: center; font-size: 2rem;
        }
        .spike {
            position: absolute; width: 10px; height: 80px; background: #222; top: 50%; left: 50%;
            transform: translate(-50%, -50%); z-index: 1; border-radius: 2px;
        }
        .spike:nth-child(2) { transform: translate(-50%, -50%) rotate(45deg); }
        .spike:nth-child(3) { transform: translate(-50%, -50%) rotate(90deg); }
        .spike:nth-child(4) { transform: translate(-50%, -50%) rotate(135deg); }
        @keyframes pulseRed { from { box-shadow: 0 0 5px #500; } to { box-shadow: 0 0 25px #f00; } }

        /* GAME OVER SCREEN */
        #game-over-screen {
            position: absolute; inset: 0; background: rgba(0,0,0,0.85);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 100; opacity: 0; pointer-events: none; transition: 0.3s;
        }
        #game-over-screen.visible { opacity: 1; pointer-events: all; }
        .crying-img {
            width: 200px; height: auto; margin-bottom: 20px;
            filter: drop-shadow(0 0 20px rgba(255, 255, 255, 0.2));
            animation: sadFloat 3s infinite ease-in-out;
        }
        @keyframes sadFloat { 0%,100% {transform: translateY(0);} 50% {transform: translateY(10px);} }

        /* -----------------------------------------------------------
           SCENE 3: SCRATCH
           ----------------------------------------------------------- */
        .scratch-area { position: relative; width: 320px; height: 420px; }
        .scratch-card {
            width: 100%; height: 100%; background: #fff; border-radius: 15px; overflow: hidden; position: relative;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }
        .secret-msg {
            position: absolute; inset: 0; padding: 30px;
            background: radial-gradient(circle, #fff, #ffe6f2); color: #333; text-align: left;
        }
        .chest-box {
            position: absolute; bottom: -60px; right: -30px;
            font-size: 4rem; color: var(--accent-gold);
            filter: drop-shadow(0 5px 15px rgba(0,0,0,0.3));
            animation: bounce 2s infinite; transition: 0.3s;
        }
        .chest-box:hover { transform: scale(1.1); }
        @keyframes bounce { 0%, 100% {transform:translateY(0);} 50% {transform:translateY(-15px);} }

        /* PUZZLE MODAL */
        .puzzle-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.85); backdrop-filter: blur(5px);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 200; opacity: 0; pointer-events: none; transition: 0.3s;
        }
        .puzzle-overlay.visible { opacity: 1; pointer-events: all; }
        .grid-3x3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 20px; }
        .p-tile {
            width: 70px; height: 70px; background: rgba(255,255,255,0.1); border-radius: 12px;
            border: 2px solid rgba(255,255,255,0.2); transition: 0.2s;
        }
        .p-tile.lit { background: var(--neon-blue); box-shadow: 0 0 30px var(--neon-blue); border-color: #fff; }

        /* SCENE 4: CAKE */
        .cake-stage { transform: scale(1.5); margin-top: 50px; }
        .cake { width: 160px; height: 100px; background: #6a1b9a; border-radius: 10px 10px 5px 5px; position: relative; }
        .icing { position: absolute; top: 0; width: 100%; height: 45px; background: #f3e5f5; border-radius: 10px 10px 20px 20px; }
        .flame {
            width: 16px; height: 26px; background: #ff9d00; border-radius: 50% 50% 20% 20%;
            position: absolute; top: -55px; left: 50%; transform: translateX(-50%);
            animation: flicker 0.1s infinite alternate; box-shadow: 0 0 20px #ff9d00;
        }

        /* UTILS */
        .toast {
            position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%);
            background: var(--neon-pink); color: #fff; padding: 15px 30px;
            border-radius: 50px; font-weight: bold; font-family: var(--font-fun);
            opacity: 0; pointer-events: none; transition: 0.3s; z-index: 300;
            box-shadow: 0 5px 20px rgba(0,0,0,0.4);
        }
        .toast.show { opacity: 1; bottom: 100px; }
        .btn-modern {
            padding: 15px 40px; background: #fff; color: var(--neon-pink);
            border: none; border-radius: 50px; font-weight: bold; font-family: var(--font-fun);
            font-size: 1.2rem; cursor: none; transition: 0.3s;
        }
        .btn-modern:hover { transform: scale(1.05); box-shadow: 0 0 20px #fff; }
    </style>
</head>
<body>

    <!-- SOUNDS -->
    <audio id="bg-music" loop>
        <source src="https://cdn.pixabay.com/download/audio/2022/11/22/audio_febc508520.mp3" type="audio/mpeg">
    </audio>
    <audio id="sfx-pop" src="https://cdn.pixabay.com/download/audio/2022/03/10/audio_c8c8a73467.mp3"></audio>
    <audio id="sfx-beep" src="https://cdn.pixabay.com/download/audio/2022/03/24/audio_078693c06e.mp3"></audio>
    <audio id="sfx-win" src="https://cdn.pixabay.com/download/audio/2021/08/04/audio_0625c153e2.mp3"></audio>
    <audio id="sfx-vault" src="https://cdn.pixabay.com/download/audio/2022/03/15/audio_730626c99c.mp3"></audio>

    <!-- CURSOR -->
    <div class="cursor-dot"></div>
    <div class="cursor-coin" id="coin-cursor"></div>
    <div class="toast" id="toast-msg"></div>

    <!-- SCENE 1: VAULT -->
    <div class="vault-overlay" id="vault-overlay">
        <div class="vault-door left"></div>
        <div class="vault-door right"></div>
        <div class="vault-lock-container">
            <h2 class="scan-msg" id="scan-text">Security Check</h2>
            <div class="charge-container" id="fp-btn">
                <div class="charge-fill"></div>
                <i class="fa-solid fa-fingerprint fingerprint-icon"></i>
            </div>
            <p style="margin-top: 20px; color: #ccc; font-family: var(--font-main);">Hold to Scan</p>
        </div>
    </div>

    <!-- WELCOME ANIMATION -->
    <div class="welcome-overlay" id="welcome-screen">
        <div class="welcome-text-container" id="welcome-text">
            <!-- Populated by JS -->
        </div>
    </div>

    <!-- PRE-GAME MESSAGE -->
    <div id="pre-game-msg">
        <h1 class="pg-text">It is your 26th birthday...</h1>
        <h1 class="pg-text" style="color: var(--accent-gold); font-size: 2rem;">You know what to do.</h1>
    </div>

    <!-- SCENE 2: BALLOONS -->
    <section id="scene-2" class="scene">
        <div class="hud">
            <span id="lives-disp" style="color: var(--neon-pink); font-size: 1.5rem;">‚ù§Ô∏è‚ù§Ô∏è‚ù§Ô∏è</span>
            <span id="score-disp" style="color: var(--accent-gold);">0 / 26</span>
        </div>
        <div id="game-area" style="position: absolute; inset: 0; overflow: hidden;"></div>
        
        <!-- GAME OVER MODAL -->
        <div id="game-over-screen">
            <img src="https://cdn-icons-png.flaticon.com/512/4080/4080536.png" class="crying-img" alt="Crying">
            <h2 style="font-family: var(--font-fun); color: #fff; margin-bottom: 20px;">Oh no! Too many bombs.</h2>
            <button class="btn-modern interactable" onclick="restartGame()">Try Again</button>
        </div>
    </section>

    <!-- SCENE 3: CHEST & SCRATCH -->
    <section id="scene-3" class="scene">
        <h2 style="font-family: var(--font-fancy); font-size: 2.5rem; margin-bottom: 20px;">The Hidden Treasury</h2>
        <div class="scratch-area">
            <div class="scratch-card">
                <div class="secret-msg">
                    <h3 style="font-family: var(--font-fancy); font-size: 2.5rem; color: var(--neon-pink);">Happy 26th Birthday!</h3>
                    <p style="margin-top: 15px; font-family: var(--font-main); color: #555; line-height: 1.6;">
                        My Dearest Assia,<br><br>
                        Another year, another level unlocked. Just like that puzzle, you have a brilliant mind that solves everything.
                        <br><br>
                        Wishing you a year as beautiful, fun, and magical as you are.
                    </p>
                    <div style="margin-top: auto; font-weight: bold; color: #333;">Forever Your Fan.</div>
                </div>
                <canvas id="scratch-c"></canvas>
            </div>
            <div class="chest-box" id="chest-btn"><i class="fa-solid fa-gift"></i></div>
        </div>
        <button id="btn-final" class="btn-modern btn-next" style="opacity: 0; pointer-events: none;">Proceed to Ceremony</button>
    </section>

    <!-- PUZZLE -->
    <div class="puzzle-overlay" id="puzzle-overlay">
        <h2 style="font-family: var(--font-fun);">Memory Matrix</h2>
        <div class="grid-3x3" id="puzzle-grid">
            <div class="p-tile" data-i="0"></div><div class="p-tile" data-i="1"></div><div class="p-tile" data-i="2"></div>
            <div class="p-tile" data-i="3"></div><div class="p-tile" data-i="4"></div><div class="p-tile" data-i="5"></div>
            <div class="p-tile" data-i="6"></div><div class="p-tile" data-i="7"></div><div class="p-tile" data-i="8"></div>
        </div>
        <p id="puzzle-status" style="margin-top: 20px; font-weight: bold;"></p>
    </div>

    <!-- SCENE 4: CAKE -->
    <section id="scene-4" class="scene">
        <h1 style="font-family: var(--font-fancy); font-size: 4rem; text-shadow: 0 0 20px rgba(0,0,0,0.5);">Make a Wish, Assia</h1>
        <div class="cake-stage">
            <div class="cake">
                <div class="icing"></div>
                <div class="flame" id="flame"></div>
            </div>
        </div>
    </section>

    <!-- SCRIPTS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <script>
        /* -----------------------------------------------------------
           CURSOR & UTILS
           ----------------------------------------------------------- */
        const cursorDot = document.querySelector('.cursor-dot');
        const coinCursor = document.getElementById('coin-cursor');
        let hasCoin = false;

        document.addEventListener('mousemove', (e) => {
            gsap.to(cursorDot, { x: e.clientX, y: e.clientY, duration: 0.1 });
            if(hasCoin) gsap.to(coinCursor, { x: e.clientX, y: e.clientY, duration: 0.15 });
        });

        function showToast(msg) {
            const t = document.getElementById('toast-msg');
            t.innerText = msg; t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        function switchScene(s1, s2) {
            const el1 = document.getElementById(s1);
            const el2 = document.getElementById(s2);
            gsap.to(el1, {opacity:0, scale:0.9, duration:0.6, onComplete:()=>{
                el1.classList.remove('active');
                el2.classList.add('active');
                gsap.fromTo(el2, {opacity:0, scale:1.1}, {opacity:1, scale:1, duration:0.6});
            }});
        }

        /* -----------------------------------------------------------
           SCENE 1: FINGERPRINT (LOGIC PRESERVED)
           ----------------------------------------------------------- */
        const fpBtn = document.getElementById('fp-btn');
        const fpFill = document.querySelector('.charge-fill');
        const scanText = document.getElementById('scan-text');
        const bgMusic = document.getElementById('bg-music');
        
        let isLocked = false; 
        let canRetry = false; 
        let charge = 0; 
        let interval = null;

        const startScan = (e) => {
            if(e && e.cancelable) e.preventDefault(); 
            
            if(isLocked) {
                fpBtn.classList.add('shake-element');
                document.getElementById('sfx-beep').play().catch(()=>{});
                scanText.innerText = "Don't be stubborn, Clean Your fingers";
                scanText.style.color = "var(--neon-pink)";
                setTimeout(() => fpBtn.classList.remove('shake-element'), 500);
                return; 
            }

            bgMusic.play().catch(()=>{});
            if(interval) clearInterval(interval);

            interval = setInterval(() => {
                if(charge < 100) { 
                    charge += 4; 
                    fpFill.style.transform = `scale(${charge/100})`; 
                } else { 
                    processScanResult(); 
                }
            }, 30);
        };

        const stopScan = (e) => { 
            if(e && e.cancelable) e.preventDefault();
            if(interval) clearInterval(interval); 
            charge = 0; 
            fpFill.style.transform = `scale(0)`; 
        };

        function processScanResult() {
            clearInterval(interval);
            
            if (!canRetry) {
                // FAIL
                document.getElementById('sfx-beep').play().catch(()=>{});
                fpBtn.classList.add('shake-element');
                fpFill.style.background = 'var(--neon-pink)';
                scanText.innerText = "Please Wipe Your Fingers and try again";
                scanText.style.color = 'var(--neon-pink)';
                
                isLocked = true;
                
                setTimeout(() => {
                    fpBtn.classList.remove('shake-element');
                    fpFill.style.background = 'var(--neon-blue)';
                    charge = 0; 
                    fpFill.style.transform = `scale(0)`;
                }, 1000);

                setTimeout(() => {
                    isLocked = false;
                    canRetry = true; 
                    scanText.innerText = "Ready. Scan Identity.";
                    scanText.style.color = '#fff';
                }, 6000); 

            } else {
                // SUCCESS
                document.getElementById('sfx-win').play().catch(()=>{});
                fpFill.style.background = 'var(--accent-gold)';
                scanText.innerText = "Identity Confirmed";
                scanText.style.color = 'var(--accent-gold)';
                setTimeout(openVault, 1000);
            }
        }

        function openVault() {
            document.getElementById('sfx-vault').play().catch(()=>{});
            document.getElementById('vault-overlay').classList.add('vault-open');
            playWelcomeAnimation();
        }

        /* -----------------------------------------------------------
           ANIMATED WELCOME (WHOLE PHRASE ANIMATED)
           ----------------------------------------------------------- */
        function playWelcomeAnimation() {
            const container = document.getElementById('welcome-text');
            const screen = document.getElementById('welcome-screen');
            screen.classList.add('visible');
            
            // Text splitted for animation
            container.innerHTML = `
                <div>
                    <span class="char">W</span><span class="char">e</span><span class="char">l</span><span class="char">c</span><span class="char">o</span><span class="char">m</span><span class="char">e</span>
                </div>
                <div style="margin-top:10px;">
                    <span class="char">M</span><span class="char">i</span><span class="char">s</span><span class="char">s</span>
                    &nbsp;
                    <span class="char">A</span><span class="char">s</span><span class="char">s</span><span class="char">i</span><span class="char">a</span>
                    &nbsp;
                    <span class="char">A</span><span class="char">h</span><span class="char">e</span><span class="char">r</span><span class="char">t</span><span class="char">i</span>
                </div>
            `;

            const chars = document.querySelectorAll('.char');
            // Advanced Staggered Animation
            gsap.fromTo(chars, 
                { opacity: 0, scale: 0, y: 100, rotateX: -90 },
                { 
                    opacity: 1, scale: 1, y: 0, rotateX: 0,
                    stagger: 0.05, duration: 1.2, ease: "elastic.out(1, 0.5)",
                    onComplete: () => {
                        // Highlight Effect for the name part
                        chars.forEach((c, i) => { if(i > 6) c.classList.add('highlight'); });
                        
                        setTimeout(() => {
                            gsap.to(screen, {opacity: 0, duration: 1});
                            gsap.to('#vault-overlay', {opacity: 0, duration: 1, pointerEvents:'none'});
                            showPreGameMsg();
                        }, 3500);
                    }
                }
            );
        }

        function showPreGameMsg() {
            const pgMsg = document.getElementById('pre-game-msg');
            const pgTexts = document.querySelectorAll('.pg-text');
            gsap.to(pgMsg, {opacity: 1, duration: 1});
            
            gsap.to(pgTexts, {
                scale: 1, stagger: 1, duration: 1, ease: 'elastic.out(1, 0.5)',
                onComplete: () => {
                    setTimeout(() => {
                        gsap.to(pgMsg, {opacity: 0, duration: 1, pointerEvents: 'none'});
                        document.getElementById('scene-2').classList.add('active');
                        gsap.fromTo('#scene-2', {opacity:0}, {opacity:1, duration:1});
                        startBalloons();
                    }, 2000);
                }
            });
        }

        /* -----------------------------------------------------------
           SCENE 2: BALLOONS (DYNAMIC DIFFICULTY)
           ----------------------------------------------------------- */
        let score = 0; 
        const target = 26;
        let lives = 3;
        let spawnInterval;
        let gameActive = false;
        let attemptCount = 0; // Tracks tries
        
        const gameArea = document.getElementById('game-area');
        const livesDisp = document.getElementById('lives-disp');

        // NEW: Penalty for clicking outside (Empty Screen)
        const handleMiss = (e) => {
            if (!gameActive) return;
            // Since hits on balloons/bombs use stopPropagation(), 
            // this will only fire if you hit the background.
            lives--;
            updateLives();
            document.getElementById('sfx-beep').play().catch(()=>{});
            gsap.to(gameArea, {x:10, yoyo:true, repeat:5, duration:0.05}); // Shake screen
            
            if(lives <= 0) {
                gameOver();
            }
        };
        gameArea.addEventListener('mousedown', handleMiss);
        gameArea.addEventListener('touchstart', handleMiss);

        function startBalloons() {
            gameActive = true;
            // Determine Difficulty parameters based on attempts
            let spawnRate = 800;
            let bombChance = 0.2;
            let speedMin = 3, speedMax = 5;

            if(attemptCount === 0) {
                // IMPOSSIBLE MODE (First Try)
                spawnRate = 250; 
                bombChance = 0.45; 
                speedMin = 1.5; speedMax = 2.5;
            } else if (attemptCount === 1) {
                // HARD MODE (Second Try)
                spawnRate = 500;
                bombChance = 0.3;
                speedMin = 2.5; speedMax = 4;
            } else {
                // NORMAL MODE (Third+ Try)
                spawnRate = 750;
                bombChance = 0.15;
                speedMin = 4; speedMax = 6;
            }

            spawnInterval = setInterval(() => {
                if(score >= target || !gameActive) { clearInterval(spawnInterval); return; }
                spawnBalloon(speedMin, speedMax, bombChance);
            }, spawnRate);
        }

        function updateLives() {
            let hearts = "";
            for(let i=0; i<3; i++) hearts += i < lives ? "‚ù§Ô∏è" : "ü§ç";
            livesDisp.innerText = hearts;
        }

        function spawnBalloon(sMin, sMax, bChance) {
            if(!gameActive) return;
            const isBomb = Math.random() < bChance;
            const startX = Math.random() * (window.innerWidth - 100);
            const duration = Math.random() * (sMax - sMin) + sMin;
            
            if (isBomb) {
                const bombWrap = document.createElement('div');
                bombWrap.className = 'bomb-container';
                bombWrap.style.left = `${startX}px`; bombWrap.style.bottom = '-100px';
                bombWrap.innerHTML = `<div class="spike"></div><div class="spike"></div><div class="spike"></div><div class="spike"></div><div class="bomb-body">‚ò†Ô∏è</div>`;
                gameArea.appendChild(bombWrap);
                
                gsap.to(bombWrap, { bottom: window.innerHeight + 100, duration: duration, ease: 'none', onComplete: () => bombWrap.remove() });
                gsap.to(bombWrap, { rotation: 360, repeat: -1, duration: 5, ease: 'linear' });

                const hitBomb = (e) => {
                    e.stopPropagation(); // Prevents handleMiss from firing
                    document.getElementById('sfx-beep').play();
                    lives--;
                    updateLives();
                    bombWrap.style.transform = "scale(1.5)";
                    gsap.to(gameArea, {x:10, yoyo:true, repeat:5, duration:0.05}); // Shake
                    setTimeout(() => bombWrap.remove(), 100);

                    if(lives <= 0) {
                        gameOver();
                    }
                };
                bombWrap.addEventListener('mousedown', hitBomb);
                bombWrap.addEventListener('touchstart', hitBomb);

            } else {
                const el = document.createElement('div');
                el.classList.add('balloon');
                const hue = Math.random() * 360;
                el.style.backgroundColor = `hsl(${hue}, 80%, 60%)`;
                el.style.color = `hsl(${hue}, 80%, 20%)`;
                el.innerText = Math.floor(Math.random()*26)+1;
                el.style.left = `${startX}px`; el.style.bottom = '-150px';
                
                gameArea.appendChild(el);
                
                gsap.to(el, { bottom: window.innerHeight + 100, duration: duration, ease: 'none', onComplete: () => el.remove() });
                gsap.to(el, { x: Math.random()*60 - 30, duration: 2, yoyo:true, repeat:-1, ease:'sine.inOut' });

                const hitBalloon = (e) => {
                    e.stopPropagation(); // Prevents handleMiss from firing
                    document.getElementById('sfx-pop').play();
                    score++;
                    confetti({ particleCount: 10, spread: 30, origin: { x: e.clientX/window.innerWidth, y: e.clientY/window.innerHeight }, colors: [`hsl(${hue}, 80%, 60%)`] });
                    el.remove();
                    document.getElementById('score-disp').innerText = `${score} / ${target}`;
                    
                    if(score >= target) {
                        gameWin();
                    }
                };
                el.addEventListener('mousedown', hitBalloon);
                el.addEventListener('touchstart', hitBalloon);
            }
        }

        function gameOver() {
            gameActive = false;
            clearInterval(spawnInterval);
            document.getElementById('game-over-screen').classList.add('visible');
        }

        window.restartGame = function() {
            attemptCount++; // Increase tries -> Make it easier
            score = 0;
            lives = 3;
            updateLives();
            document.getElementById('score-disp').innerText = "0 / 26";
            document.getElementById('game-over-screen').classList.remove('visible');
            gameArea.innerHTML = ''; 
            startBalloons();
        }

        function gameWin() {
            gameActive = false;
            clearInterval(spawnInterval);
            document.getElementById('sfx-win').play();
            triggerFireworks();
            setTimeout(() => {
                switchScene('scene-2', 'scene-3');
            }, 4000);
        }

        function triggerFireworks() {
            var duration = 3 * 1000;
            var end = Date.now() + duration;
            (function frame() {
                confetti({
                    particleCount: 5, angle: 60, spread: 55, origin: { x: 0 },
                    colors: ['#ff0', '#f0f', '#0ff']
                });
                confetti({
                    particleCount: 5, angle: 120, spread: 55, origin: { x: 1 },
                    colors: ['#ff0', '#f0f', '#0ff']
                });
                if (Date.now() < end) {
                    requestAnimationFrame(frame);
                }
            }());
        }

        /* -----------------------------------------------------------
           SCENE 3: CHEST & PUZZLE
           ----------------------------------------------------------- */
        const chestBtn = document.getElementById('chest-btn');
        const puzzleOverlay = document.getElementById('puzzle-overlay');
        const tiles = document.querySelectorAll('.p-tile');
        let sequence = [], playerSeq = [];

        chestBtn.addEventListener('click', () => {
            if(hasCoin) return;
            puzzleOverlay.classList.add('visible');
            startPuzzle();
        });

        function startPuzzle() {
            sequence = [];
            for(let i=0; i<5; i++) sequence.push(Math.floor(Math.random()*9));
            document.getElementById('puzzle-status').innerText = "Memorize...";
            setTimeout(playSequence, 1000);
        }

        function playSequence() {
            let i = 0; playerSeq = [];
            const int = setInterval(() => {
                if(i >= sequence.length) { clearInterval(int); document.getElementById('puzzle-status').innerText = "Repeat!"; return; }
                const tile = document.querySelector(`.p-tile[data-i="${sequence[i]}"]`);
                tile.classList.add('lit');
                document.getElementById('sfx-pop').play();
                setTimeout(()=>tile.classList.remove('lit'), 300);
                i++;
            }, 500);
        }

        tiles.forEach(t => {
            t.addEventListener('click', () => {
                const idx = parseInt(t.dataset.i);
                t.classList.add('lit'); setTimeout(()=>t.classList.remove('lit'), 200);
                playerSeq.push(idx);
                if(playerSeq[playerSeq.length-1] !== sequence[playerSeq.length-1]) {
                    document.getElementById('puzzle-status').innerText = "Wrong!";
                    document.getElementById('sfx-beep').play();
                    playerSeq = []; setTimeout(startPuzzle, 1000); return;
                }
                if(playerSeq.length === sequence.length) {
                    document.getElementById('sfx-win').play();
                    puzzleOverlay.classList.remove('visible');
                    gsap.to(chestBtn, {opacity:0, scale:0});
                    hasCoin = true;
                    document.body.style.cursor = 'none';
                    gsap.to(coinCursor, {scale: 1});
                    showToast("Coin Acquired! Scratch Now!");
                }
            });
        });

        /* -----------------------------------------------------------
           SCRATCH LOGIC
           ----------------------------------------------------------- */
        function initScratch() {
            const cvs = document.getElementById('scratch-c');
            const ctxC = cvs.getContext('2d');
            cvs.width = 320; cvs.height = 420;
            ctxC.fillStyle = '#C0C0C0'; ctxC.fillRect(0,0,320,420);
            ctxC.font = '24px Poppins'; ctxC.fillStyle = '#555'; ctxC.textAlign = 'center';
            ctxC.fillText("LOCKED", 160, 200); ctxC.font = '16px Poppins'; ctxC.fillText("(Requires Coin)", 160, 230);

            let isDrawing = false;
            const scratch = (e) => {
                if(!isDrawing) return;
                if(!hasCoin) { isDrawing=false; showToast("Don't make your fingers dirty, Assia!"); return; }
                const rect = cvs.getBoundingClientRect();
                const x = (e.touches?e.touches[0].clientX:e.clientX) - rect.left;
                const y = (e.touches?e.touches[0].clientY:e.clientY) - rect.top;
                ctxC.globalCompositeOperation = 'destination-out';
                ctxC.beginPath(); ctxC.arc(x,y,25,0,Math.PI*2); ctxC.fill();
                
                const d = ctxC.getImageData(0,0,320,420).data;
                let c = 0; for(let i=3; i<d.length; i+=4) if(d[i]===0) c++;
                if(c > (d.length/4)*0.5) {
                    gsap.to(cvs, {opacity:0, duration:1, pointerEvents:'none'});
                    gsap.to('#btn-final', {opacity:1, pointerEvents:'all', y:-20});
                }
            };
            cvs.addEventListener('mousedown', ()=>isDrawing=true); cvs.addEventListener('touchstart', ()=>isDrawing=true);
            window.addEventListener('mouseup', ()=>isDrawing=false); window.addEventListener('touchend', ()=>isDrawing=false);
            cvs.addEventListener('mousemove', scratch); cvs.addEventListener('touchmove', scratch);
            cvs.addEventListener('click', ()=> { if(!hasCoin) showToast("Don't make your fingers dirty, Assia!"); });
        }
        document.getElementById('btn-final').addEventListener('click', () => switchScene('scene-3', 'scene-4'));
        initScratch(); 

        document.getElementById('flame').addEventListener('click', () => {
            document.getElementById('flame').style.opacity = 0;
            triggerFireworks();
            setTimeout(() => {
                document.querySelector('#scene-4 h1').innerHTML = "Happy Birthday<br>Assia!";
                document.querySelector('#scene-4 h1').style.color = "var(--accent-gold)";
            }, 1000);
        });

        // Event Listeners for Fingerprint
        fpBtn.addEventListener('mousedown', startScan);
        fpBtn.addEventListener('touchstart', startScan, {passive: false});
        fpBtn.addEventListener('mouseup', stopScan);
        fpBtn.addEventListener('touchend', stopScan);
        fpBtn.addEventListener('mouseleave', stopScan);
    </script>
</body>
</html>